name: dbt CI/CD Pipeline - Football Analytics
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch: null
jobs:
  dbt_ci_job:
    runs-on: ubuntu-latest
    env:
      DBT_SERVER: ${{ secrets.DBT_SERVER }}
      DBT_DATABASE: ${{ secrets.DBT_DATABASE }}
      DBT_SCHEMA: ${{ secrets.DBT_SCHEMA }}
      DBT_USER: ${{ secrets.DBT_USER }}
      DBT_PASSWORD: ${{ secrets.DBT_PASSWORD }}
    steps:
      - name: ðŸ“¦ Checkout repository
        uses: actions/checkout@v4
      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.12
      - name: âš™ï¸ Install dbt and Dependencies
        run: |
          # 1. Install prerequisites for the MS SQL Driver (unixODBC)
          sudo apt-get update
          sudo apt-get install -y unixodbc unixodbc-dev
          
          # 2. Add Microsoft repositories to fetch the official driver
          curl https://packages.microsoft.com/keys/microsoft.asc | sudo tee /etc/apt/trusted.gpg.d/microsoft.asc
          # Assuming Ubuntu 22.04 runner, adjust if using a different image
          curl https://packages.microsoft.com/config/ubuntu/22.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list

          # 3. Update repos and install the ODBC Driver 18 (msodbcsql18)
          sudo apt-get update
          sudo ACCEPT_EULA=Y apt-get install -y msodbcsql18

          # 4. Install dbt adapter and packages
          pip install dbt-sqlserver
          dbt deps
      - name: ðŸ› ï¸ Run dbt Build and Test
        run: >
          echo "Running dbt debug to confirm connection..."

          dbt debug --target ci


          echo "Running dbt build (runs, tests, seeds) on CI target..."

          # The 'build' command is a shortcut for run, test, and seed operations.

          # Alternatively, you can run: dbt seed && dbt run && dbt test

          dbt build --target ci
      - name: ðŸ§¹ Clean up
        run: >
          echo "Dbt run complete."

          # Optional: Remove temporary files if needed, though runners are ephemeral.
